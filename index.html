<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gestor Suro - Análisis de Migración</title>
    <!-- Test auto-deploy: 2025-09-12 -->
    <link rel="stylesheet" href="styles.css">
    <!-- Chart.js para visualizaciones -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google APIs removidas - usando backend API -->
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet.js para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet MarkerCluster para agrupación de marcadores -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1><i class="fas fa-chart-line"></i> Gestor Suroeste</h1>
                <p>Análisis de Migración: Nutresa vs Nexo</p>
                <div class="header-controls">
                    <!-- Selector de Escenarios -->
                    <div class="scenario-selector">
                        <label for="scenarioSelect">
                            <i class="fas fa-layer-group"></i> Escenario:
                        </label>
                        <select id="scenarioSelect">
                            <option value="Base" selected>Base</option>
                        </select>
                    </div>
                    
                    <!-- Indicador de Escenario Activo -->
                    <div class="scenario-indicator">
                        <span id="currentScenario">Base</span>
                    </div>
                    
                    <!-- Estado de Conexión -->
                    <div class="connection-status">
                        <span id="connectionStatus" class="status-disconnected">
                            <i class="fas fa-circle"></i> Desconectado
                        </span>
                        <button id="connectBtn" class="connect-btn">
                            <i class="fas fa-plug"></i> Conectar a Google Sheets
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navegación por pestañas -->
        <nav class="tab-navigation">
            <div class="tab-container">
                <button class="tab-btn active" data-tab="clientes">
                    <i class="fas fa-users"></i>
                    Clientes
                </button>
                <button class="tab-btn" data-tab="poblacion">
                    <i class="fas fa-chart-bar"></i>
                    Población
                </button>
                <button class="tab-btn" data-tab="financiero">
                    <i class="fas fa-calculator"></i>
                    Financiero
                </button>
                <button class="tab-btn" data-tab="mapa">
                    <i class="fas fa-map-marked-alt"></i>
                    Mapa
                </button>
            </div>
        </nav>

        <!-- Contenido de las pestañas -->
        <div class="tab-content">
            <!-- Pestaña Clientes -->
            <div id="clientes-tab" class="tab-pane active">
                <!-- Controles de filtros compactos -->
                <div class="filters-section-compact">
                    <div class="filters-row">
                        <div class="filter-group-compact">
                            <select id="origenFilter">
                                <option value="">Origen: Todos</option>
                            </select>
                        </div>
                        <div class="filter-group-compact">
                            <select id="atencionFilter">
                                <option value="">Atención: Todas</option>
                            </select>
                        </div>
                        <div class="filter-group-compact">
                            <select id="segmentoFilter">
                                <option value="">Segmento: Todos</option>
                            </select>
                        </div>
                        <div class="filter-group-compact">
                            <select id="poblacionFilter">
                                <option value="">Población: Todas</option>
                            </select>
                        </div>
                        <div class="filter-group-compact">
                            <select id="zonaGeograficaFilter">
                                <option value="">Zona: Todas</option>
                            </select>
                        </div>
                        <div class="filter-group-compact">
                            <select id="categoriaFilter">
                                <option value="">Categoría: Todas</option>
                                <option value="Top">Top</option>
                                <option value="Grande">Grande</option>
                                <option value="Mediano">Mediano</option>
                                <option value="Pequeño">Pequeño</option>
                            </select>
                        </div>
                        <div class="filter-group-compact">
                            <select id="cambioAtencionFilter">
                                <option value="">Cambio: Todos</option>
                            </select>
                        </div>
                    </div>
                    <div class="controls-row">
                        <div class="search-group">
                            <input type="text" id="searchInput" placeholder="Buscar cliente...">
                        </div>
                        <div class="indicators-group">
                            <div class="client-counter">
                                <span id="clientCounter">Total de clientes únicos: 0</span>
                            </div>
                            <div class="sales-sum">
                                <span id="salesSum">Suma Venta Promedio: $0</span>
                            </div>
                            <div class="change-counter">
                                <span id="changeCounter">Clientes con cambios: 0</span>
                            </div>
                            <div class="change-counter">
                                <span id="changeSalesCounter">Ventas de cambios: $0</span>
                            </div>

                        </div>
                        <div class="action-buttons">

                            <button id="clearFilters" class="clear-filters-btn-modern">
                                <i class="fas fa-filter"></i> Limpiar
                            </button>

                        </div>
                    </div>
                </div>

        <!-- Tabla de Datos -->
        <section class="data-table-section">
            <div class="table-container">
                <table id="clientsTable">
                    <thead>
                        <!-- Los encabezados se cargarán dinámicamente -->
                    </thead>
                    <tbody id="clientsTableBody">
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
            <!-- Controles de Paginación -->
            <div id="paginationControls" class="pagination-controls">
                <!-- Los controles se generarán dinámicamente -->
            </div>
        </section>
    </div>

    <!-- Pestaña Población -->
    <div id="poblacion-tab" class="tab-pane">
        <div class="poblacion-summary-section">
            <!-- Tabla de Resumen por Población -->
            <div class="table-container">
                <table id="poblacionTable" class="summary-table">
                    <thead>
                        <tr>
                            <th data-column="poblacion" class="sortable">Población <span class="sort-indicator"></span></th>
                            <th data-column="totalClientes" class="sortable">Total<br>Clientes <span class="sort-indicator"></span></th>
                            <th data-column="clientesNexo" class="sortable">Clientes<br>Nexo <span class="sort-indicator"></span></th>
                            <th data-column="porcentajeNexo" class="sortable">%<br>Nexo <span class="sort-indicator"></span></th>
                            <th data-column="clientesDirecta" class="sortable">Clientes<br>Directa <span class="sort-indicator"></span></th>
                            <th data-column="porcentajeDirecta" class="sortable">%<br>Directa <span class="sort-indicator"></span></th>
                            <th data-column="deltaClientes" class="sortable">Δ Clientes <span class="sort-indicator"></span></th>
                            <th data-column="clientesConCambios" class="sortable">$ Cambios <span class="sort-indicator"></span></th>
                            <th data-column="ventasNexo" class="sortable">Ventas<br>Nexo <span class="sort-indicator"></span></th>
                            <th data-column="porcentajeVentasNexo" class="sortable">% Ventas<br>Nexo <span class="sort-indicator"></span></th>
                        <th data-column="ventasDirecta" class="sortable">Ventas<br>Directa <span class="sort-indicator"></span></th>
                        <th data-column="porcentajeVentasDirecta" class="sortable">% Ventas<br>Directa <span class="sort-indicator"></span></th>
                        <th data-column="ventasTotal" class="sortable sort-desc">Ventas<br>Totales <span class="sort-indicator"></span></th>
                        <th data-column="clienteTop" class="sortable">Clientes<br>TOP <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="poblacionTableBody">
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pestaña Financiero -->
    <div id="financiero-tab" class="tab-pane">
        <!-- Panel de Resumen Consolidado -->
        <div class="financial-summary">
            <div class="summary-item">
                <span class="summary-label">Ventas Totales:</span>
                <span id="summary-ventas-total" class="summary-value">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Costos Totales:</span>
                <span id="summary-costos-total" class="summary-value">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Diferencia Recursos:</span>
                <span id="summary-recursos-total" class="summary-value">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">ICA Total:</span>
                <span id="summary-ica-total" class="summary-value">$0</span>
            </div>
            <div class="summary-item highlight">
                <span class="summary-label">% Costo x Servir Total:</span>
                <span id="summary-costo-porcentaje" class="summary-value">0%</span>
            </div>
        </div>
        
        <div class="financial-container">
            <!-- Bloque Nexo -->
            <div class="financial-block">
                <h3><i class="fas fa-network-wired"></i> NEXO</h3>
                
                <div class="financial-section">
                    <h4>Ventas</h4>
                    <div class="calculated-field">
                        <label>Venta Estimada Base:</label>
                        <span id="nexo-venta-base" class="calculated-value">$0</span>
                    </div>
                    <div class="calculated-field">
                        <label>Rezonificación Ventas:</label>
                        <span id="nexo-rezonificacion-ventas" class="calculated-value">$0</span>
                    </div>
                    <div class="calculated-field">
                        <label>Venta Estimada + Rezonificación:</label>
                        <span id="nexo-venta-total" class="calculated-value">$0</span>
                    </div>
                </div>

                <div class="financial-section">
                    <h4>Costos</h4>
                    <div class="calculated-field">
                        <label>Costo por Servir Base:</label>
                        <span id="nexo-costo-base" class="calculated-value">$0</span>
                    </div>
                    <div class="resources-section">
                        <label>Recursos Adicionales:</label>
                        <div id="nexo-resources-list" class="resources-list">
                            <!-- Los recursos se cargarán desde ConfigFinanciera -->
                        </div>
                    </div>
                    <div class="calculated-field">
                        <label>Costo por Servir + Rezonificación:</label>
                        <span id="nexo-costo-total" class="calculated-value">$0</span>
                    </div>
                </div>

                <div class="financial-section">
                    <h4>ICA</h4>
                    <div class="calculated-field">
                        <label>% ICA:</label>
                        <span id="nexo-ica-porcentaje" class="calculated-value">0%</span>
                    </div>
                    <div class="calculated-field">
                        <label>Valor ICA:</label>
                        <span id="nexo-ica-valor" class="calculated-value">$0</span>
                    </div>
                </div>

                <div class="financial-section totals">
                    <div class="calculated-field">
                        <label>Total Gastos:</label>
                        <span id="nexo-gastos-total" class="calculated-value total">$0</span>
                    </div>
                    <div class="calculated-field">
                        <label>% Costo x Servir Final:</label>
                        <span id="nexo-costo-porcentaje" class="calculated-value percentage">0%</span>
                    </div>
                </div>
            </div>

            <!-- Bloque Directa -->
            <div class="financial-block">
                <h3><i class="fas fa-direct-hit"></i> DIRECTA</h3>
                
                <div class="financial-section">
                    <h4>Ventas</h4>
                    <div class="calculated-field">
                        <label>Venta Estimada Base:</label>
                        <span id="directa-venta-base" class="calculated-value">$0</span>
                    </div>
                    <div class="calculated-field">
                        <label>Rezonificación Ventas:</label>
                        <span id="directa-rezonificacion-ventas" class="calculated-value">$0</span>
                    </div>
                    <div class="calculated-field">
                        <label>Venta Estimada + Rezonificación:</label>
                        <span id="directa-venta-total" class="calculated-value">$0</span>
                    </div>
                </div>

                <div class="financial-section">
                    <h4>Costos</h4>
                    <div class="calculated-field">
                        <label>Costo por Servir Base:</label>
                        <span id="directa-costo-base" class="calculated-value">$0</span>
                    </div>
                    <div class="resources-section">
                        <label>Recursos Adicionales:</label>
                        <div id="directa-resources-list" class="resources-list">
                            <!-- Los recursos se cargarán desde ConfigFinanciera -->
                        </div>
                    </div>
                    <div class="calculated-field">
                        <label>Costo por Servir + Rezonificación:</label>
                        <span id="directa-costo-total" class="calculated-value">$0</span>
                    </div>
                </div>

                <div class="financial-section">
                    <h4>ICA</h4>
                    <div class="calculated-field">
                        <label>% ICA:</label>
                        <span id="directa-ica-porcentaje" class="calculated-value">0%</span>
                    </div>
                    <div class="calculated-field">
                        <label>Valor ICA:</label>
                        <span id="directa-ica-valor" class="calculated-value">$0</span>
                    </div>
                </div>

                <div class="financial-section totals">
                    <div class="calculated-field">
                        <label>Total Gastos:</label>
                        <span id="directa-gastos-total" class="calculated-value total">$0</span>
                    </div>
                    <div class="calculated-field">
                        <label>% Costo x Servir Final:</label>
                        <span id="directa-costo-porcentaje" class="calculated-value percentage">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestaña Mapa -->
    <div id="mapa-tab" class="tab-pane">
        <h2><i class="fas fa-map-marked-alt"></i> Mapa de Clientes por Municipio</h2>
        
        <div class="map-container">
            <div class="map-sidebar">
                <div class="map-legend">
                    <h4>Leyenda:</h4>
                    <div class="legend-item">
                        <span class="legend-marker nexo"></span>
                        <span>Exclusiva Nexo</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-marker directa"></span>
                        <span>Exclusiva Directa</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-marker compartida"></span>
                        <span>Compartida</span>
                    </div>
                    <div class="legend-note">
                        <small><i class="fas fa-info-circle"></i> Tamaño del marcador = Ventas totales del municipio</small>
                        <small><i class="fas fa-star"></i> Borde dorado = Ubicación con cambios vs escenario Base</small>
                    </div>
                </div>
                
                <!-- Filtros del Mapa -->
                <div class="map-filters">
                    <h4>Filtros:</h4>
                    <div class="filter-group">
                        <label>Mostrar por Atención:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="filter-atencion-nexo" checked>
                                <span class="checkmark"></span>
                                Atención Nexo
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="filter-atencion-directa" checked>
                                <span class="checkmark"></span>
                                Atención Directa
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="map-stats">
                    <h4>Estadísticas:</h4>
                    <div class="stat-item">
                        <span class="stat-label">Total Ubicaciones:</span>
                        <span id="total-locations" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Exclusiva Nexo:</span>
                        <span id="nexo-locations" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Exclusiva Directa:</span>
                        <span id="directa-locations" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Compartidas:</span>
                        <span id="shared-locations" class="stat-value">0</span>
                    </div>
                </div>
            </div>
            <div id="map" class="map-display"></div>
        </div>
    </div>

    <!-- Modal de Configuración -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuración de Google Sheets</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sheetId">ID de la Hoja de Cálculo:</label>
                    <input type="text" id="sheetId" placeholder="Ingresa el ID de tu Google Sheet">
                    <small>Puedes encontrar el ID en la URL de tu hoja de cálculo</small>
                </div>
                <div class="form-group">
                    <label for="sheetRange">Rango de Datos:</label>
                    <input type="text" id="sheetRange" value="A1:Z1000" placeholder="Ej: A1:Z1000">
                </div>
                <div class="form-group">
                    <label for="apiKey">API Key de Google:</label>
                    <input type="password" id="apiKey" placeholder="Tu API Key de Google Sheets">
                    <small>Asegúrate de que la API Key tenga permisos para Google Sheets</small>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveConfigBtn" class="save-btn">Guardar y Conectar</button>
                <button id="cancelConfigBtn" class="cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configuración de Categorías -->


    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando datos...</p>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="services/apiService.js"></script>
    <script src="app.js"></script>
</body>
</html>